# Sample workflow to access AWS resources when workflow is tied to branch
# The workflow Creates static website using aws s3
name: Test Cicd
on:
  push:
    branches:
    - test-cicd
env:
  AWS_REGION : ${{ secrets.AWS_REGION }}
  ASSUME_ROLE: ${{ secrets.ASSUME_ROLE_S3_BUCKET_LOUIS_20251225 }}
  S3_HOST_BUCKET: ${{ secrets.S3_HOST_BUCKET }}
  TOKEN_TELE: ${{ secrets.TOKEN_TELE }}
  CHAT_ID: ${{ secrets.CHAT_ID }}
  
# permission can be added at job level or workflow level
permissions:
  id-token: write   # This is required for requesting the JWT
  contents: read    # This is required for actions/checkout
jobs:
  jobA:
    name: jobA
    runs-on: ubuntu-latest
    outputs: 
      output1: ${{ steps.step1.outputs.test }}
    steps:
      # - name: set env 
      #   run: echo "var1=hahaha" >> $GITHUB_ENV

      - uses: some/secret-store@27b31702a0e7fc50959f5ad993c78deac1bdfc29
        with:
          credentials: ${{ secrets.SECRET_STORE_CREDENTIALS }}
          instance: ${{ secrets.SECRET_STORE_INSTANCE }}

      - name: haha
        id: step1
        shell: bash
        run: |
          SECRET_HANDLE=$(secret-store store-secret "${{ env.AWS_REGION }}")
          echo "test=$SECRET_HANDLE" >> "$GITHUB_OUTPUT"

  jobB: 
    name: jobB
    runs-on: ubuntu-latest
    needs: jobA
    steps:
      - uses: some/secret-store@27b31702a0e7fc50959f5ad993c78deac1bdfc29
        with:
          credentials: ${{ secrets.SECRET_STORE_CREDENTIALS }}
          instance: ${{ secrets.SECRET_STORE_INSTANCE }}

      - name: Get output
        shell: bash
        run: |
          SECRET_HANDLE="${{ needs.jobA.outputs.output1 }}"
          RETRIEVED_SECRET=$(secret-store retrieve-secret "$SECRET_HANDLE")
          echo "::add-mask::$RETRIEVED_SECRET"
          echo "We retrieved our masked secret: $RETRIEVED_SECRET"

    